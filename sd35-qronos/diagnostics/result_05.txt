(bacp) C:\Users\Fatim_Sproj\Desktop\Fatim\edge\Project\AI624-Diffusion-Quantization\sd35-qronos>python scripts/diag_05_layer_groups.py                                                                                                          C:\Users\Fatim_Sproj\anaconda3\envs\bacp\lib\site-packages\torch\cuda\__init__.py:61: FutureWarning: The pynvml package is deprecated. Please install nvidia-ml-py instead. If you did not install pynvml directly, please report this to the maintainers of the package that installed pynvml for you.                                                                   import pynvml  # type: ignore[import]                                                                                 2025-12-21 03:51:46.419988: I tensorflow/core/util/port.cc:153] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.                                                                   2025-12-21 03:51:47.075665: I tensorflow/core/util/port.cc:153] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.                                                                   ============================================================                                                            LAYER GROUP ANALYSIS                                                                                                    ============================================================                                                                                                                                                                                    [0] FP16 Baseline...                                                                                                    Loading SD 3.5 Medium from stabilityai/stable-diffusion-3.5-medium...                                                   Loading checkpoint shards: 100%|█████████████████████████████████████████████████████████| 2/2 [00:00<00:00, 10.67it/s] Loading pipeline components...:  56%|████████████████████████████▉                       | 5/9 [00:01<00:01,  3.78it/s]You set `add_prefix_space`. The tokenizer needs to be converted from the slow tokenizers                                 Loading pipeline components...: 100%|████████████████████████████████████████████████████| 9/9 [00:02<00:00,  4.03it/s] Pipeline loaded successfully                                                                                              Transformer: 4.60 GB                                                                                                    Device: cuda:0                                                                                                        100%|██████████████████████████████████████████████████████████████████████████████████| 20/20 [00:01<00:00, 15.02it/s]   Image mean: 80.7                                                                                                                                                                                                                              [1] Testing attn_q layers...                                                                                                Patterns: ['attn.to_q', 'attn2.to_q', 'add_q_proj']                                                                 Loading SD 3.5 Medium from stabilityai/stable-diffusion-3.5-medium...                                                   Loading checkpoint shards: 100%|█████████████████████████████████████████████████████████| 2/2 [00:00<00:00, 10.34it/s] Loading pipeline components...: 100%|████████████████████████████████████████████████████| 9/9 [00:02<00:00,  4.16it/s] Pipeline loaded successfully                                                                                              Transformer: 4.60 GB                                                                                                    Device: cuda:0                                                                                                            Quantized 61 layers                                                                                                 100%|██████████████████████████████████████████████████████████████████████████████████| 20/20 [00:01<00:00, 15.69it/s]     Image mean: 71.8 ✅ OK                                                                                                                                                                                                                      [2] Testing attn_k layers...                                                                                                Patterns: ['attn.to_k', 'attn2.to_k', 'add_k_proj']                                                                 Loading SD 3.5 Medium from stabilityai/stable-diffusion-3.5-medium...                                                   Loading checkpoint shards: 100%|█████████████████████████████████████████████████████████| 2/2 [00:00<00:00, 10.57it/s] Loading pipeline components...: 100%|████████████████████████████████████████████████████| 9/9 [00:02<00:00,  3.99it/s] Pipeline loaded successfully                                                                                              Transformer: 4.60 GB                                                                                                    Device: cuda:0                                                                                                            Quantized 61 layers                                                                                                 100%|██████████████████████████████████████████████████████████████████████████████████| 20/20 [00:01<00:00, 15.73it/s]     Image mean: 84.5 ✅ OK                                                                                                                                                                                                                      [3] Testing attn_v layers...                                                                                                Patterns: ['attn.to_v', 'attn2.to_v', 'add_v_proj']                                                                 Loading SD 3.5 Medium from stabilityai/stable-diffusion-3.5-medium...                                                   Loading checkpoint shards: 100%|█████████████████████████████████████████████████████████| 2/2 [00:00<00:00, 10.42it/s] Loading pipeline components...: 100%|████████████████████████████████████████████████████| 9/9 [00:02<00:00,  4.23it/s] Pipeline loaded successfully                                                                                              Transformer: 4.60 GB                                                                                                    Device: cuda:0                                                                                                            Quantized 61 layers                                                                                                 100%|██████████████████████████████████████████████████████████████████████████████████| 20/20 [00:01<00:00, 15.77it/s]     Image mean: 87.7 ✅ OK                                                                                                                                                                                                                      [4] Testing attn_out layers...                                                                                              Patterns: ['attn.to_out', 'attn2.to_out', 'to_add_out']                                                             Loading SD 3.5 Medium from stabilityai/stable-diffusion-3.5-medium...                                                   Loading checkpoint shards: 100%|█████████████████████████████████████████████████████████| 2/2 [00:00<00:00, 10.36it/s] Loading pipeline components...: 100%|████████████████████████████████████████████████████| 9/9 [00:02<00:00,  4.22it/s] Pipeline loaded successfully                                                                                              Transformer: 4.60 GB                                                                                                    Device: cuda:0                                                                                                            Quantized 60 layers                                                                                                 100%|██████████████████████████████████████████████████████████████████████████████████| 20/20 [00:01<00:00, 15.83it/s]     Image mean: 79.8 ✅ OK                                                                                                                                                                                                                      [5] Testing ffn_up layers...                                                                                                Patterns: ['ff.net.0.proj', 'ff_context.net.0.proj']                                                                Loading SD 3.5 Medium from stabilityai/stable-diffusion-3.5-medium...                                                   Loading checkpoint shards: 100%|█████████████████████████████████████████████████████████| 2/2 [00:00<00:00,  9.03it/s] Loading pipeline components...: 100%|████████████████████████████████████████████████████| 9/9 [00:02<00:00,  3.94it/s] Pipeline loaded successfully                                                                                              Transformer: 4.60 GB                                                                                                    Device: cuda:0                                                                                                            Quantized 47 layers                                                                                                 100%|██████████████████████████████████████████████████████████████████████████████████| 20/20 [00:01<00:00, 15.64it/s]     Image mean: 85.4 ✅ OK                                                                                                                                                                                                                      [6] Testing ffn_down layers...                                                                                              Patterns: ['ff.net.2', 'ff_context.net.2']                                                                          Loading SD 3.5 Medium from stabilityai/stable-diffusion-3.5-medium...                                                   Loading checkpoint shards: 100%|█████████████████████████████████████████████████████████| 2/2 [00:00<00:00,  8.95it/s] Loading pipeline components...: 100%|████████████████████████████████████████████████████| 9/9 [00:02<00:00,  3.74it/s] Pipeline loaded successfully                                                                                              Transformer: 4.60 GB                                                                                                    Device: cuda:0                                                                                                            Quantized 47 layers                                                                                                 100%|██████████████████████████████████████████████████████████████████████████████████| 20/20 [00:01<00:00, 15.70it/s]     Image mean: 82.9 ✅ OK                                                                                                                                                                                                                      [7] Testing norm layers...                                                                                                  Patterns: ['norm1.linear', 'norm1_context.linear']                                                                  Loading SD 3.5 Medium from stabilityai/stable-diffusion-3.5-medium...                                                   Loading checkpoint shards: 100%|█████████████████████████████████████████████████████████| 2/2 [00:00<00:00,  9.54it/s] Loading pipeline components...: 100%|████████████████████████████████████████████████████| 9/9 [00:02<00:00,  4.17it/s] Pipeline loaded successfully                                                                                              Transformer: 4.60 GB                                                                                                    Device: cuda:0                                                                                                            Quantized 48 layers                                                                                                 100%|██████████████████████████████████████████████████████████████████████████████████| 20/20 [00:01<00:00, 15.92it/s]     Image mean: 107.7 ✅ OK                                                                                                                                                                                                                     [8] Testing embed layers...                                                                                                 Patterns: ['time_text_embed', 'context_embedder']                                                                   Loading SD 3.5 Medium from stabilityai/stable-diffusion-3.5-medium...                                                   Loading checkpoint shards: 100%|█████████████████████████████████████████████████████████| 2/2 [00:00<00:00,  9.68it/s] Loading pipeline components...: 100%|████████████████████████████████████████████████████| 9/9 [00:02<00:00,  4.18it/s] Pipeline loaded successfully                                                                                              Transformer: 4.60 GB                                                                                                    Device: cuda:0                                                                                                            Quantized 5 layers                                                                                                  100%|██████████████████████████████████████████████████████████████████████████████████| 20/20 [00:01<00:00, 15.69it/s]     Image mean: 55.3 ✅ OK                                                                                                                                                                                                                      ============================================================                                                            SUMMARY: Impact of Each Layer Group                                                                                     ============================================================                                                            Group           Layers     Quality    Status                                                                            ---------------------------------------------                                                                           attn_q          61         71.8       OK                                                                                attn_k          61         84.5       OK                                                                                attn_v          61         87.7       OK                                                                                attn_out        60         79.8       OK                                                                                ffn_up          47         85.4       OK                                                                                ffn_down        47         82.9       OK                                                                                norm            48         107.7      OK                                                                                embed           5          55.3       OK                                                                                                                                                                                                        ✅ No single layer group causes black images alone                                                                         The issue is from combining multiple groups                                                                                                                                                                                                  Results saved to diagnosis_layer_groups                                                                                                                                                                                                         (bacp) C:\Users\Fatim_Sproj\Desktop\Fatim\edge\Project\AI624-Diffusion-Quantization\sd35-qronos> 